@startuml "BrokerX - Vue Déploiement"
!theme plain
skinparam backgroundColor #FFFFFF
skinparam linetype ortho
skinparam shadowing false
skinparam artifactStyle rectangle

'title et contexte
' ----------------------------------------------------------------------
title "BrokerX — Diagramme de Déploiement (Microservices)"

actor "Utilisateur" as User

node "Navigateur Web\n(Chrome, Firefox, Safari)" as Browser {
  [Interface utilisateur\n(HTML/CSS/JS, React)]
}

cloud "SMTP Provider\n(Gmail, Outlook...)\nport 587" as SMTP

node "Hôte (VM/Serveur)" as Host {
  node "Docker Engine" as Docker {
    node "Réseau bridge: brokerx-network" as Net {
      node "Conteneur: frontend\n(React, Node.js)\nport 3000" as FrontendC {
        artifact "frontend app"
      }
      node "Conteneur: nginx-load-balancer\n(NGINX)\nport 8078" as NginxC {
        artifact "nginx.conf"
      }
      node "Conteneur: api-gateway\n(Spring Boot)\nport 8079" as GatewayC {
        artifact "api-gateway.jar"
      }
      node "Conteneur: auth-service\n(Spring Boot)\nport 8081" as AuthC {
        artifact "auth-service.jar"
      }
      node "Conteneur: order-service\n(Spring Boot)\nport 8082" as OrderC {
        artifact "order-service.jar"
      }
      node "Conteneur: wallet-service\n(Spring Boot)\nport 8083" as WalletC {
        artifact "wallet-service.jar"
      }
      node "Conteneur: matching-service\n(Spring Boot)\nport 8084" as MatchingC {
        artifact "matching-service.jar"
      }
      node "Conteneur: market-data-service\n(Spring Boot)\nport 8087" as MarketDataC {
        artifact "market-data-service.jar"
      }
      node "Conteneur: notification-service\n(Spring Boot)\nport 8088" as NotificationC {
        artifact "notification-service.jar"
      }
      node "Conteneur: swagger-ui\n(port 8085)" as SwaggerC {
        artifact "swagger-ui"
      }
      node "Conteneur: prometheus\n(port 8090)" as PrometheusC {
        artifact "prometheus.yml"
      }
      node "Conteneur: grafana\n(port 3001)" as GrafanaC {
        artifact "dashboard.json"
      }
      node "Conteneur: rabbitmq\n(RabbitMQ)\nport 5672, 15672" as RabbitMQC {
        artifact "rabbitmq-definitions.json"
      }
      database "PostgreSQL Auth\nport 5433" as DBAuth
      database "PostgreSQL Order\nport 5434" as DBOrder
      database "PostgreSQL Wallet\nport 5435" as DBWallet
      database "PostgreSQL Matching\nport 5436" as DBMatching
      database "PostgreSQL MarketData\nport 5437" as DBMarketData
      database "PostgreSQL Notification\nport 5438" as DBNotification
      frame "Volumes: persistance" as Volumes
    }
  }
}

' Connexions principales (simplifiées)
User --> Browser : Utilise
Browser --> FrontendC : HTTP 3000
Browser --> MarketDataC : "WebSocket 8087\n(données marché temps réel)"
Browser --> NotificationC : "WebSocket 8088\n(notifications push)"
FrontendC --> GatewayC : API REST
GatewayC --> NginxC : Proxy interne
NginxC --> AuthC : Microservice
NginxC --> OrderC : Microservice
NginxC --> WalletC : Microservice
NginxC --> MatchingC : Microservice
NginxC --> MarketDataC : Microservice
NginxC --> NotificationC : Microservice
AuthC --> DBAuth
OrderC --> DBOrder
WalletC --> DBWallet
MatchingC --> DBMatching
MarketDataC --> DBMarketData
NotificationC --> DBNotification
GatewayC --> SwaggerC : Docs
PrometheusC --> GatewayC : Récolte des données
GrafanaC --> PrometheusC
AuthC -right-> SMTP : "Envoi d'emails\n(vérification, MFA)"
NotificationC -right-> SMTP : "Envoi d'emails\n(notifs)"
' Connexions événementielles
OrderC --> RabbitMQC : "Publie et\nconsomme événements"
MatchingC --> RabbitMQC : "Publie et\nconsomme événements"
NotificationC --> RabbitMQC : "Consomme événements"

legend right
Utilisateur : Personne qui utilise la plateforme BrokerX
Navigateur : Accès web à l'interface utilisateur
frontend : Application React, interface utilisateur
api-gateway : Point d'entrée unique, gère la sécurité et le routage
nginx-load-balancer : Répartition des requêtes vers les microservices
auth-service : Microservice d'authentification et gestion des utilisateurs
order-service : Microservice de gestion des ordres de trading
wallet-service : Microservice de gestion des portefeuilles et soldes
matching-service : Microservice de matching et exécution des transactions
market-data-service : Microservice de diffusion des données de marché en temps réel
notification-service : Microservice de notifications et alertes utilisateur
swagger-ui : Documentation centralisée des APIs
prometheus : Collecte des métriques pour le monitoring.
**Prometheus est réellement connecté à chacun des microservices pour récolter les données à afficher pour l'observabilité,
mais pour des besoins de clarté, j'ai juste mis le lien avec le gateway.
grafana : Visualisation des métriques et dashboards
PostgreSQL Auth/Order/Wallet/Matching/Market-data/Notification : Bases de données dédiées à chaque microservice
SMTP Provider : Service externe pour l'envoi d'e-mails
rabbitmq : Message broker pour l'architecture événementielle et Saga chorégraphiée (avec définitions des queues)
PostgreSQL Order/Wallet/Matching : Bases de données avec tables outbox pour garantir la cohérence
end legend

@enduml
