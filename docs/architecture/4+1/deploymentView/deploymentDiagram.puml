@startuml "BrokerX - Vue Déploiement"
!theme plain
skinparam backgroundColor #FFFFFF
skinparam linetype ortho
skinparam shadowing false
skinparam artifactStyle rectangle
skinparam packageStyle rectangle
skinparam ArrowThickness 2
skinparam defaultTextAlignment center

title "BrokerX — Diagramme de Déploiement (Microservices)"

' ========== USER LAYER (TOP) ==========
together {
  actor "Utilisateur" as User
  node "Navigateur Web\n(Chrome, Firefox, Safari)" as Browser {
    [Interface utilisateur\n(HTML/CSS/JS, React)]
  }
}

node "Docker Host" as Docker {
  package "brokerx-network" as Network {

    ' ========== MONITORING & OBSERVABILITY LAYER ==========
    package "Monitoring & Observability" as MonitoringLayer #LightYellow {
      together {
        node "Conteneur: prometheus" as PrometheusC {
          artifact "prometheus.yml"
        }
        node "Conteneur: grafana" as GrafanaC {
          artifact "dashboard.json"
        }
        node "Conteneur: swagger-ui" as SwaggerC {
          artifact "springdoc-openapi-ui"
        }
      }
    }

    ' ========== ENTRY POINT LAYER ==========
    package "Points d'Entrée" as EntryLayer #LightBlue {
      node "Conteneur: frontend\n(React, Node.js)" as FrontendC {
        artifact "React app"
      }

      node "Conteneur: api-gateway\n(Spring Boot)" as GatewayC {
        artifact "api-gateway.jar"
      }

      node "Conteneur: nginx-load-balancer\n(NGINX)" as NginxC {
        artifact "nginx.conf"
      }
    }

    ' ========== SERVICE LAYER ==========
    package "Services Applicatifs" as ServiceLayer #LightGreen {
      together {
        node "Conteneur: auth-service\n(Spring Boot)" as AuthC {
          artifact "auth-service.jar"
        }

        node "Conteneur: order-service\n(Spring Boot)" as OrderC {
          artifact "order-service.jar"
        }

        node "Conteneur: wallet-service\n(Spring Boot)" as WalletC {
          artifact "wallet-service.jar"
        }
      }

      together {
        node "Conteneur: matching-service\n(Spring Boot)" as MatchingC {
          artifact "matching-service.jar"
        }

        node "Conteneur: market-data-service\n(Spring Boot)" as MarketDataC {
          artifact "market-data-service.jar"
        }

        node "Conteneur: notification-service\n(Spring Boot)" as NotificationC {
          artifact "notification-service.jar"
        }
      }
    }

    ' ========== MESSAGE BROKER LAYER ==========
    package "Message Broker" as MessagingLayer #LightCoral {
      node "Conteneur: rabbitmq\n(RabbitMQ)" as RabbitMQC {
        artifact "rabbitmq-definitions.json"
      }
    }

    ' ========== DATA LAYER ==========
    package "Persistance des Données" as DataLayer #LightCyan {
      together {
        database "PostgreSQL Auth" as DBAuth
        database "PostgreSQL Order" as DBOrder
        database "PostgreSQL Wallet" as DBWallet
      }

      together {
        database "PostgreSQL Matching" as DBMatching
        database "PostgreSQL MarketData" as DBMarketData
        database "PostgreSQL Notification" as DBNotification
      }

      frame "Volumes: persistance" as Volumes
    }
  }
}

' ========== EXTERNAL SERVICES POSITIONED CLEANLY ==========
cloud "SMTP Provider\n(Gmail, Outlook...)\nport 587" as SMTP

' ========== POSITIONING HINTS ==========
User -[hidden]down-> Docker
Browser -[hidden]down-> Docker
DataLayer -[hidden]right-> SMTP

' ========== USER FLOW ==========
User --> Browser : Utilise
Browser --> FrontendC : HTTP 3000
Browser -right-> MarketDataC : "WebSocket 8087"
Browser --> NotificationC : "WebSocket 8088"

' ========== ENTRY POINT ROUTING ==========
FrontendC --> GatewayC : API REST
GatewayC --> NginxC : Proxy interne
GatewayC --> SwaggerC : Docs

' ========== SERVICE ROUTING ==========
NginxC --> AuthC : Microservice
NginxC --> OrderC : Microservice
NginxC --> WalletC : Microservice
NginxC --> MatchingC : Microservice
NginxC --> MarketDataC : Microservice
NginxC --> NotificationC : Microservice

' ========== DATABASE CONNECTIONS ==========
AuthC --> DBAuth : JDBC
OrderC --> DBOrder : JDBC
WalletC --> DBWallet : JDBC
MatchingC --> DBMatching : JDBC
MarketDataC --> DBMarketData : JDBC
NotificationC --> DBNotification : JDBC

' ========== MESSAGE BROKER CONNECTIONS ==========
OrderC --> RabbitMQC : AMQP
MatchingC --> RabbitMQC : AMQP
NotificationC --> RabbitMQC : AMQP

' ========== MONITORING CONNECTIONS ==========
PrometheusC --> GatewayC : Récolte des données
PrometheusC --> ServiceLayer : Récole des données
GrafanaC --> PrometheusC : Affichage des métriques

' ========== EXTERNAL SERVICES (CLEAN CONNECTIONS) ==========
AuthC ..> SMTP : "Envoi d'emails\n(vérification, MFA)"
NotificationC ..> SMTP : "Envoi d'emails\n(notifs)"

' ========== LAYOUT HINTS ==========
MonitoringLayer -[hidden]down-> EntryLayer
EntryLayer -[hidden]down-> ServiceLayer
ServiceLayer -[hidden]down-> MessagingLayer
MessagingLayer -[hidden]down-> DataLayer

legend right
Utilisateur : Personne qui utilise la plateforme BrokerX
Navigateur : Accès web à l'interface utilisateur
frontend : Application React, interface utilisateur
api-gateway : Point d'entrée unique, gère la sécurité et le routage
nginx-load-balancer : Répartition des requêtes vers les microservices
auth-service : Microservice d'authentification et gestion des utilisateurs
order-service : Microservice de gestion des ordres de trading
wallet-service : Microservice de gestion des portefeuilles et soldes
matching-service : Microservice de matching et exécution des transactions
market-data-service : Microservice de diffusion des données de marché en temps réel
notification-service : Microservice de notifications et alertes utilisateur
swagger-ui : Documentation centralisée des APIs
prometheus : Collecte des métriques pour le monitoring.
**Prometheus est réellement connecté à chacun des microservices pour récolter les données à afficher pour l'observabilité,
mais pour des besoins de clarté, j'ai juste mis le lien avec le gateway.
grafana : Visualisation des métriques et dashboards
PostgreSQL Auth/Order/Wallet/Matching/Market-data/Notification : Bases de données dédiées à chaque microservice
SMTP Provider : Service externe pour l'envoi d'e-mails
rabbitmq : Message broker pour l'architecture événementielle et Saga chorégraphiée (avec définitions des queues)
PostgreSQL Order/Wallet/Matching : Bases de données avec tables outbox pour garantir la cohérence
end legend

@enduml
