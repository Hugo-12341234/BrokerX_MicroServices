@startuml "BrokerX - Component Diagram"
!theme plain
skinparam backgroundColor #FFFFFF
skinparam componentStyle uml2
skinparam linetype ortho
skinparam shadowing false
skinparam ArrowColor #606060
skinparam FontColor #404040
skinparam nodesep 120
skinparam ranksep 180
left to right direction

title "BrokerX - Component Diagram"

actor "Utilisateur" as Utilisateur

package "Frontend" #EDE7F6 {
  component "Thymeleaf UI" as ThymeleafUI
  component "HTML Templates" as HtmlTemplates
}

package "Backend Spring Boot" #F5F5F5 {
  package "Controllers" #FFECB3 {
    [UserController] as UserCtrl
    [WalletController] as WalletCtrl
    [UserVerificationController] as UserVerifCtrl
    [OrderController] as OrderCtrl
    [HomeController] as HomeCtrl
    [AuthController] as AuthCtrl
  }

  package "Services du domaine" #FFF3E0 {
    [AuthenticationService] as AuthSvc
    [WalletDepositService] as WalletDepositSvc
    [RegistrationService] as RegistrationSvc
    [OrderService] as OrderSvc
    [PreTradeValidationService] as PreTradeValidationSvc
    [StockService] as StockSvc
  }

  package "Adapteurs" #E6F7FF {
    [UserAdapter] as UserAdapter
    [TransactionPersistenceAdapter] as TransactionAdapter
    [VerificationTokenAdapter] as VerificationTokenAdapter
    [OrderAdapter] as OrderAdapter
    [MfaChallengeAdapter] as MfaChallengeAdapter
    [AuditAdapter] as AuditAdapter
    [StockAdapter] as StockAdapter
    [JwtTokenAdapter] as JwtTokenAdapter
    [EmailAdapter] as EmailAdapter
  }
}

package "Ports" #FFF9C4 {
  interface "UserPort" as IUserPort
  interface "TransactionPort" as ITransPort
  interface "VerificationTokenPort" as IVerifPort
  interface "OrderPort" as IOrderPort
  interface "MfaChallengePort" as IMfaPort
  interface "AuditPort" as IAuditPort
  interface "EmailSenderPort" as IEmailPort
  interface "JwtTokenPort" as IJwtPort
  interface "PaymentServicePort" as IPaymentPort
}

package "Infrastructure" #E2FFCC {
  database "PostgreSQL" as DB
  cloud "SMTP (Gmail)" as SMTP
}

' --- Flèches pointillées : dépendance métier (seulement les ports réellement utilisés)
ThymeleafUI ..> UserCtrl
ThymeleafUI ..> WalletCtrl
ThymeleafUI ..> UserVerifCtrl
ThymeleafUI ..> OrderCtrl
ThymeleafUI ..> HomeCtrl
ThymeleafUI ..> AuthCtrl
ThymeleafUI ..> HtmlTemplates : Rendu HTML

UserCtrl ..> RegistrationSvc
UserCtrl ..> AuthSvc
WalletCtrl ..> WalletDepositSvc
UserVerifCtrl ..> RegistrationSvc
OrderCtrl ..> OrderSvc
HomeCtrl ..> AuthSvc
AuthCtrl ..> AuthSvc

WalletDepositSvc ..> ITransPort
WalletDepositSvc ..> IUserPort
WalletDepositSvc ..> IPaymentPort
WalletDepositSvc ..> IAuditPort

RegistrationSvc ..> IUserPort
RegistrationSvc ..> IVerifPort
RegistrationSvc ..> IEmailPort
RegistrationSvc ..> IAuditPort

OrderSvc ..> IOrderPort
OrderSvc ..> IUserPort

AuthSvc ..> IUserPort
AuthSvc ..> IMfaPort
AuthSvc ..> IEmailPort
AuthSvc ..> IAuditPort
AuthSvc ..> IJwtPort

PreTradeValidationSvc ..> IUserPort
StockSvc ..> IPaymentPort

' --- Flèches pleines : chaque adapteur n'est relié qu'à son port
UserAdapter --> IUserPort
TransactionAdapter --> ITransPort
VerificationTokenAdapter --> IVerifPort
OrderAdapter --> IOrderPort
MfaChallengeAdapter --> IMfaPort
AuditAdapter --> IAuditPort
EmailAdapter --> IEmailPort
JwtTokenAdapter --> IJwtPort
StockAdapter --> IPaymentPort

' --- Flèche unique : tous les adapteurs vers PostgreSQL
"Adapteurs" --> DB : JDBC

EmailAdapter --> SMTP : SMTP 587

' --- Layout hints pour réduire les croisements et espacer les blocs
UserCtrl -[hidden]-> RegistrationSvc
WalletCtrl -[hidden]-> WalletDepositSvc
OrderCtrl -[hidden]-> OrderSvc
AuthCtrl -[hidden]-> AuthSvc
UserCtrl -[hidden]-> IUserPort
WalletDepositSvc -[hidden]-> IUserPort
OrderSvc -[hidden]-> IUserPort
@enduml
