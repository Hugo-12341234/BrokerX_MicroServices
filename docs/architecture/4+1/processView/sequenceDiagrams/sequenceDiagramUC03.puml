@startuml
' UC-03 — Dépôt dans le portefeuille (BrokerX)

title Sequence Diagram\nUC-03 — Dépôt portefeuille avec idempotence

skinparam ParticipantPadding 8
skinparam BoxPadding 6
skinparam Shadowing false
skinparam ArrowColor #2c3e50
skinparam ActorStyle awesome
autonumber

actor Client
participant APIGateway
participant WalletController
participant WalletDepositService as WalletService
participant "Domain(Audit, Transaction, Wallet)" as Domain
participant "Adapters (Transaction, User, Wallet)" as Adapters
participant "Persistence (JPA Repos)" as Persistence

== Soumission du dépôt ==
Client -> APIGateway: POST localhost:8079/api/v1/wallet/deposit\nDepositRequest(amount, idempotencyKey)
APIGateway -> WalletController: POST /api/v1/wallet/deposit\nDepositRequest(amount, idempotencyKey)
WalletController -> WalletService: deposit(userId, amount, idempotencyKey)

' Récupération du portefeuille
WalletService -> Adapters: findByUserId(userId)
Adapters -> Persistence: findByUserId(userId)
Persistence --> Adapters: Optional<Wallet>
Adapters --> WalletService: Optional<Wallet>
opt portefeuille inexistant
    WalletService -> Domain: créer Wallet
    Domain --> WalletService: Wallet
    WalletService -> Adapters: save(Wallet)
    Adapters -> Persistence: save(Wallet)
    Persistence --> Adapters: Wallet
    Adapters --> WalletService: Wallet
end

alt erreur de validation (montant invalide, clé manquante, compte introuvable ou inactif)
  WalletService -> Domain: Créer audit d'échec
  Domain --> WalletService: Audit
  WalletService -> Adapters: save(Audit)
    Adapters -> Persistence: save(Audit)
    Persistence --> Adapters: Audit
    Adapters --> WalletService: Audit
  WalletService --> WalletController: Exception (4xx/5xx)
  WalletController --> APIGateway: Réponse d'erreur
  APIGateway --> Client: Réponse d'erreur
else dépôt accepté
    WalletService -> Adapters: findByIdempotencyKey(idempotencyKey)
    Adapters -> Persistence: findByIdempotencyKey(idempotencyKey)
    Persistence --> Adapters: Optional<Transaction>
    Adapters --> WalletService: Optional<Transaction>
  opt idempotence (transaction qui existe déjà)
    WalletService --> WalletController: transaction.id
    WalletController --> APIGateway: 200 OK DepositResponse(transaction.id)
    APIGateway --> Client: 200 OK DepositResponse(transaction.id, status=SETTLED)
  end

  WalletService -> Domain: créer Transaction (PENDING)
    Domain --> WalletService: Transaction
    WalletService -> Adapters: save(Transaction)
  Adapters -> Persistence: save(Transaction)
  Persistence --> Adapters: Transaction
  Adapters --> WalletService: Transaction

  WalletService -> Adapters: processPayment(idempotencyKey, userId)
  Adapters --> WalletService: boolean

  opt paiement rejeté
    WalletService -> Domain: markAsFailed(transaction)
    WalletService -> Adapters: save(transaction)
    Adapters -> Persistence: save(transaction)
    Persistence --> Adapters: transaction
    Adapters --> WalletService: transaction
    WalletService -> Domain: Créer audit d'échec
    Domain --> WalletService: Audit
    WalletService -> Adapters: save(Audit)
    Adapters -> Persistence: save(Audit)
    Persistence --> Adapters: Audit
    Adapters --> WalletService: Audit
    WalletService --> WalletController: DepositResult.failure("Paiement refusé")
    WalletController --> APIGateway: Réponse d'erreur
    APIGateway --> Client: Réponse d'erreur
   end

  WalletService -> Domain: setBalance(amount)
  WalletService -> Adapters: save(wallet)
  Adapters -> Persistence: save(wallet)
  Persistence --> Adapters: wallet
  Adapters --> WalletService: wallet

    WalletService -> Domain: markAsSettled(transaction)
    WalletService -> Adapters: save(transaction)
    Adapters -> Persistence: save(transaction)

  WalletService -> Domain: créer Audit de succès
    Domain --> WalletService: Audit
    WalletService -> Adapters: save(Audit)
  Adapters -> Persistence: save(Audit)
  Persistence --> Adapters: Audit
  Adapters --> WalletService: Audit

  WalletService --> WalletController: DepositResult.success(transaction.id)
  WalletController --> APIGateway: 200 OK DepositResponse(id, status=SETTLED)
  APIGateway --> Client: 200 OK DepositResponse(id, status=SETTLED)
@end