@startuml
' UC-05 — Placement d’un ordre (BrokerX)

title Sequence Diagram\nUC-05 — Placement d’un ordre

skinparam ParticipantPadding 8
skinparam BoxPadding 6
skinparam Shadowing false
skinparam ArrowColor #2c3e50
skinparam ActorStyle awesome
autonumber

actor Client
participant OrderController
participant OrderService
participant PreTradeValidationService
participant "Domain(Order)" as Domain
participant "Adapters (Order, Stock)" as Adapters
participant "Persistence (JPA Repos)" as Persistence

note over Persistence
Contrôles pré-trade : statut du compte, pouvoir d’achat, bandes, ticks, short-sell, etc.
end note

== Soumission de l’ordre ==
Client -> OrderController: POST /orders/place\nOrderRequest(symbol, side, type, timeInForce, quantity, limitPrice, clientOrderId)
OrderController -> OrderService: placeOrder(symbol, side, type, timeInForce, quantity, limitPrice, userID)

OrderService -> Adapters: findByClientOrderId(clientOrderId)
Adapters -> Persistence: findByClientOrderId(clientOrderId)
Persistence --> Adapters: Optional<Order>
Adapters --> OrderService: Optional<Order>

opt idempotence (ordre déjà placé)
    OrderService --> OrderController: Order(orderId, status)
    OrderController --> Client: 200 OrderResponse(orderId, status)
end

OrderService -> Adapters: findUserById(userId)
  Adapters -> Persistence: findUserById(userId)
  Persistence --> Adapters: User
  Adapters --> OrderService: User

OrderService -> PreTradeValidationService: validateOrder(user,\nsymbol, side, type, timeInForce, quantity, limitPrice)

alt erreur de validation ou pré-trade (quantité, prix, pouvoir d’achat, bande de prix, tick size, short-sell, etc.)
  PreTradeValidationService --> OrderService: ValidationError(raison)
    OrderService -> Domain: créer l'ordre(REJECTED)
      Domain --> OrderService: Order
      OrderService -> Adapters: save(Order)
    Adapters -> Persistence: save(Order)
    Persistence --> Adapters: Order(REJECTED)
    Adapters --> OrderService: Order(REJECTED)
  OrderService --> OrderController: Order(REJECTED)
  OrderController --> Client: 400 OrderResponse(REJETÉ, raison)
else ordre accepté
    PreTradeValidationService --> OrderService: ValidationSuccess
  OrderService -> Domain: créer l'ordre(ACCEPTED)
    Domain --> OrderService: Order
    OrderService -> Adapters: save(Order)
  Adapters -> Persistence: save(Order)
  Persistence --> Adapters: Order(ACCEPTED)
  Adapters --> OrderService: Order(ACCEPTED)

  OrderService --> OrderController: Order(ACCEPTED)
  OrderController --> Client: 200 OK OrderResponse(orderId, "ACCEPTÉ")
end

@enduml

