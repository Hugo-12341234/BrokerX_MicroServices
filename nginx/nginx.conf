worker_processes auto;

events {
    worker_connections 2048;
}

http {
    # Configuration globale pour les proxies
    resolver 127.0.0.11 ipv6=off valid=10s;
    resolver_timeout 5s;

    access_log /var/log/nginx/access.log;
    error_log  /var/log/nginx/error.log info;

    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection "";
    proxy_connect_timeout 2s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;

    # ======================================================
    # SERVEUR PRINCIPAL - Port 80 (Load Balancer / Gateway)
    # ======================================================
    server {
        listen 80;
        server_name localhost;

        # --- CORS global pour Swagger UI (depuis localhost:8085) ---
        add_header 'Access-Control-Allow-Origin' 'http://localhost:8085' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;

        # --- Réponses aux requêtes OPTIONS ---
        location ~* ^.+$ {
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' 'http://localhost:8085' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;
                add_header 'Access-Control-Max-Age' 3600;
                return 204;
            }
        }

        # ==============================
        # Swagger API DOCS PROXIES
        # ==============================

        # Auth Service Swagger
        location ^~ /swagger/auth/ {
            rewrite ^/swagger/auth/(.*)$ /$1 break;
            proxy_pass http://auth_upstream;
        }

        # Order Service Swagger
        location ^~ /swagger/order/ {
            rewrite ^/swagger/order/(.*)$ /$1 break;
            proxy_pass http://order_upstream;
        }

        # Wallet Service Swagger
        location ^~ /swagger/wallet/ {
            rewrite ^/swagger/wallet/(.*)$ /$1 break;
            proxy_pass http://wallet_upstream;
        }

        # Matching Service Swagger
        location ^~ /swagger/matching/ {
            rewrite ^/swagger/matching/(.*)$ /$1 break;
            proxy_pass http://matching_upstream;
        }

        # Notification Service Swagger
        location ^~ /swagger/notification/ {
            rewrite ^/swagger/notification/(.*)$ /$1 break;
            proxy_pass http://notification_upstream;
        }

        # Market-data Service Swagger (si applicable)
        location ^~ /swagger/marketdata/ {
            rewrite ^/swagger/marketdata/(.*)$ /$1 break;
            proxy_pass http://marketdata_upstream;
        }

        # ==============================
        # Routes principales API
        # ==============================

        location /auth/ {
            proxy_pass http://auth_upstream/;
        }

        location /order/ {
            proxy_pass http://order_upstream/;
        }

        location /wallet/ {
            proxy_pass http://wallet_upstream/;
        }

        location /matching/ {
            proxy_pass http://matching_upstream/;
        }

        location /notification/ {
            proxy_pass http://notification_upstream/;
        }

        location /market-data/ {
            proxy_pass http://marketdata_upstream/;
        }

        # ==============================
        # WebSocket pour notification-service
        # ==============================
        location = /ws/notification {
            proxy_pass http://notification_upstream/ws/notification;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_http_version 1.1;
        }
        location /ws/notification/ {
            proxy_pass http://notification_upstream/ws/notification/;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_http_version 1.1;
        }

        # WebSocket pour market-data-service
        location = /ws/market-data {
            proxy_pass http://marketdata_upstream/ws/market-data;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_http_version 1.1;
        }
        location /ws/market-data/ {
            proxy_pass http://marketdata_upstream/ws/market-data/;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_http_version 1.1;
        }

        # Route par défaut
        location / {
            return 404;
        }
    }

    # ======================================================
    # UPSTREAMS - chaque microservice Spring Boot
    # ======================================================

    # Auth Service (port 8081)
    upstream auth_upstream {
        zone auth_zone 64k;
        least_conn;
        server auth-service:8081 resolve;
    }
    server {
        listen 9001;
        location / { proxy_pass http://auth_upstream; }
    }

    # Order Service (port 8082)
    upstream order_upstream {
        zone order_zone 64k;
        least_conn;
        server order-service:8082 resolve;
    }
    server {
        listen 9002;
        location / { proxy_pass http://order_upstream; }
    }

    # Wallet Service (port 8083)
    upstream wallet_upstream {
        zone wallet_zone 64k;
        least_conn;
        server wallet-service:8083 resolve;
    }
    server {
        listen 9003;
        location / { proxy_pass http://wallet_upstream; }
    }

    # Matching Service (port 8084)
    upstream matching_upstream {
        zone matching_zone 64k;
        least_conn;
        server matching-service:8084 resolve;
    }
    server {
        listen 9004;
        location / { proxy_pass http://matching_upstream; }
    }

    # Notification Service (port 8086)
    upstream notification_upstream {
        zone notification_zone 64k;
        least_conn;
        server notification-service:8086 resolve;
    }
    server {
        listen 9005;
        location / { proxy_pass http://notification_upstream; }
    }

    # Market-data Service (port 8087)
    upstream marketdata_upstream {
        zone marketdata_zone 64k;
        least_conn;
        server market-data-service:8087 resolve;
    }
    server {
        listen 9006;
        location / { proxy_pass http://marketdata_upstream; }
    }
}